map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}


server {
	listen 80;
	listen [::]:80;
	server_name {{ morla_photoprism_public_url }};
	client_max_body_size 500M;

	# Uncomment to redirect HTTP to HTTPS
	return 301 https://$host$request_uri;
}

server {
	server_name {{ morla_photoprism_public_url }};
	listen [::]:443 ssl http2;
	listen 443 ssl http2;

    	# With SSL via Let's Encrypt
	ssl_certificate      /certs/live/{{ morla_photoprism_public_url }}/fullchain.pem;
	ssl_certificate_key  /certs/live/{{ morla_photoprism_public_url }}/privkey.pem;

	# include /config/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
	#ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

	location / {
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $host;

		proxy_pass http://{{ morla_internal_ip }}:{{ morla_photoprism_reverse_proxy_port }}/;

		proxy_buffering off;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";

		client_max_body_size 500M;
	}
}
